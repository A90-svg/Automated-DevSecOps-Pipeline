# ============================================
# FINSECURE DEVSECOPS PIPELINE
# ============================================
# 
# Automated CI/CD pipeline demonstrating DevSecOps best practices
# 
# SECURITY TOOLS INTEGRATED:
# - SAST: SonarCloud (Static Application Security Testing)
# - SCA: Snyk (Software Composition Analysis)
# - DAST: OWASP ZAP (Dynamic Application Security Testing)
# 
# COMPLIANCE FRAMEWORKS:
# - PDPL (Bahrain Personal Data Protection Law)
# - CBB Cybersecurity Framework
# 
# PIPELINE FEATURES:
# - Multi-stage security scanning
# - Security gates with merge blocking
# - Automated reporting and artifact storage
# - Docker containerization with security best practices
# ============================================

name: Automated DevSecOps Pipeline

# ============================================
# WORKFLOW TRIGGERS
# ============================================
on:
  # Trigger on push to main or develop branches
  # Ignores documentation changes to prevent unnecessary pipeline runs
  push:
    branches: [main, develop]
    paths-ignore:
      - '**/*.md'
      - '**/*.txt'
      - 'docs/**'
      - '.github/**'
      - 'LICENSE'

  # Trigger on pull requests targeting main branch
  # Ensures all PRs are scanned before merge
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

  # Allow manual triggering from GitHub Actions UI
  # Useful for on-demand security scans
  workflow_dispatch:
    inputs:
      run_dast:
        description: 'Run DAST scan (can be disabled for faster testing)'
        required: false
        type: boolean
        default: true

# ============================================
# GLOBAL ENVIRONMENT VARIABLES
# ============================================
env:
  DOCKER_IMAGE_NAME: finsecure-app
  NODE_VERSION: '22.20.0'

# ============================================
# WORKFLOW JOBS
# ============================================
jobs:
  # ============================================
  # JOB 1: BUILD AND TEST
  # ============================================
  # Purpose: Build application, run tests, and create Docker image
  # Security: Validates code quality and basic functionality
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # Checkout repository with full history
      # Full history needed for SonarCloud analysis
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GIT_TOKEN }}

      # Setup Node.js environment with caching
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # Install dependencies with npm ci for deterministic builds
      - name: Install dependencies
        run: npm ci

      # Cache node modules for reuse in other jobs
      - name: Upload Node Modules
        uses: actions/upload-artifact@v4
        with:
          name: node-modules
          path: ./node_modules
          retention-days: 1

      # Run unit tests with coverage
      # Tests validate application functionality
      - name: Run Tests
        run: |
          echo "Running unit tests with coverage..."
          npm test
        continue-on-error: true

      # Run ESLint for code quality
      # Identifies potential bugs and enforces coding standards
      - name: Run Linting
        run: |
          echo "Running ESLint..."
          npm run lint
        continue-on-error: true

      # Setup Docker Buildx for multi-platform builds
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build Docker image for deployment
      # Uses multi-stage Dockerfile for security
      - name: Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Save Docker Image
      - name: Save Docker Image
        run: docker save ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }} > /tmp/docker-image.tar

      # Upload Docker Image
      - name: Upload Docker Image
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: /tmp/docker-image.tar
          retention-days: 1

      # Build a summary
      - name: Build Summary
        run: |
          echo "Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "Dependencies installed" >> $GITHUB_STEP_SUMMARY
          echo "Docker image built: \`${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # JOB 2: STATIC APPLICATION SECURITY TESTING (SAST)
  # ============================================
  # Purpose: Analyze source code for security vulnerabilities
  # Tool: SonarCloud - detects bugs, vulnerabilities, code smells
  # Compliance: OWASP Top 10, PDPL, CBB Framework
  sast-scan:
    name: SAST Scan (SonarCloud)
    runs-on: ubuntu-latest
    needs: build-and-test
    timeout-minutes: 10
    continue-on-error: true

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Run SonarCloud static analysis
      # Scans for: security hotspots, bugs, code smells, coverage
      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          GIT_TOKEN: ${{ secrets.GIT_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        continue-on-error: true
        with:
          args: >
            -Dsonar.qualitygate.wait=false
            -Dsonar.coverage.exclusions=**

      # Generate SAST summary report
      - name: SAST Summary
        if: always()
        run: |
          echo "## SAST Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "**Tool**: SonarCloud" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "[View detailed results](https://sonarcloud.io/project/overview?id=${{ secrets.SONAR_PROJECT_KEY || 'A90-svg_Automated-DevSecOps-Pipeline' }})" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # JOB 3: SOFTWARE COMPOSITION ANALYSIS (SCA)
  # ============================================
  # Purpose: Scan dependencies for known vulnerabilities
  # Tool: Snyk - identifies CVEs in npm packages
  # Compliance: Dependency security, supply chain security
  sca-scan:
    name: SCA Scan (Snyk)
    runs-on: ubuntu-latest
    needs: build-and-test
    timeout-minutes: 8

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Dependencies
        uses: actions/download-artifact@v4
        with:
          name: node-modules
          path: ./node_modules

      # Install Snyk CLI globally
      # Snyk scans dependencies for known vulnerabilities (CVEs)
      - name: Install Snyk CLI
        run: npm install -g snyk

      # Run Snyk security scan
      # Scans npm packages against vulnerability database
      # Outputs JSON and SARIF formats for analysis
      - name: Run Snyk Security Scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --json-file-output=snyk-results.json --sarif-file-output=snyk-results.sarif

      # Fallback scan if primary action fails
      # Ensures we get results even if action has issues
      - name: Fallback Snyk Scan (if action fails)
        if: failure()
        run: |
          echo "Running fallback Snyk scan..."
          snyk test --json > snyk-results.json || true
          snyk test --sarif > snyk-results.sarif || true

      # Verify scan results files were created
      # Debug step to ensure artifacts are available
      - name: Check Snyk Results File
        run: |
          echo "Checking for Snyk results files..."
          ls -la *.json *.sarif 2>/dev/null || echo "No result files found"
          if [ -f "snyk-results.json" ]; then
            echo "snyk-results.json found"
            cat snyk-results.json | head -20
          else
            echo "snyk-results.json not found"
          fi

      # Upload Snyk scan results as artifacts
      # Preserves scan results for 30 days for compliance
      - name: Upload Snyk Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: snyk-results
          path: |
            snyk-results.json
            snyk-results.sarif
          retention-days: 30
          if-no-files-found: warn

      # Generate SCA summary report
      - name: SCA Summary
        if: always()
        run: |
          echo "## SCA Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "**Tool**: Snyk" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "[View detailed results](https://app.snyk.io/)" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # JOB 4: DYNAMIC APPLICATION SECURITY TESTING (DAST)
  # ============================================
  # Purpose: Test running application for security vulnerabilities
  # Tool: OWASP ZAP - scans for web application vulnerabilities
  # Compliance: OWASP Top 10, runtime security testing
  dast-scan:
    name: DAST Scan (OWASP ZAP)
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event.inputs.run_dast != 'false'
    timeout-minutes: 15

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Download pre-built Docker image from build job
      # Reuses image to save time and ensure consistency
      - name: Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      # Load Docker image into local registry
      # Makes image available for running container
      - name: Load Docker Image
        run: docker load < /tmp/docker-image.tar

      # Start application in Docker container
      # Configures with production environment variables
      - name: Start Application
        run: |
          docker run -d \
            -p 3000:3000 \
            --name finsecure-app \
            -e NODE_ENV=production \
            -e PORT=3000 \
            -e EMAILJS_SERVICE_ID=${{ secrets.EMAILJS_SERVICE_ID }} \
            -e EMAILJS_TEMPLATE_ID=${{ secrets.EMAILJS_TEMPLATE_ID }} \
            -e EMAILJS_PUBLIC_KEY=${{ secrets.EMAILJS_PUBLIC_KEY }} \
            -e EMAILJS_PRIVATE_KEY=${{ secrets.EMAILJS_PRIVATE_KEY }} \
            -e ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS }} \
            ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
            
          echo "Waiting for application to start..."
          sleep 30  

          # Health check with retry logic
          # Ensures application is ready before ZAP scan
          for i in {1..10}; do
           if curl -s http://localhost:3000/health > /dev/null 2>&1; then
              echo "Application is healthy"
              break
            fi
            echo "Waiting... ($i/10)"
              sleep 5
            if [ $i -eq 10 ]; then
              echo "Application failed to start"
              docker logs finsecure-app
              exit 1
            fi
            done

      # Run OWASP ZAP baseline security scan
      # Scans running application for common web vulnerabilities
      # Generates HTML report for compliance documentation
      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j'
          allow_issue_writing: false
        continue-on-error: true

      # Upload ZAP scan report as artifact
      # Preserves DAST results for 30 days for compliance
      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-scan-results
          path: report_html.html
          retention-days: 30

      # Clean up Docker container
      # Ensures proper cleanup regardless of scan outcome
      - name: Stop Application
        if: always()
        run: |
          docker stop finsecure-app || true
          docker rm finsecure-app || true

      # Generate DAST summary report
      - name: DAST Summary
        run: |
          echo "## DAST Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "**Tool**: OWASP ZAP" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "Report uploaded as artifact" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # JOB 5: SECURITY GATE
  # ============================================
  # Purpose: Evaluate all security scan results
  # Blocks merges on high-severity vulnerabilities
  # Compliance: Security policy enforcement
  security-gate:
    name: Security Gate
    runs-on: ubuntu-latest
    needs: [sast-scan, sca-scan, dast-scan]
    if: always()

    steps:
      # Evaluate all security scan results
      # Determines if build passes or fails security gate
      - name: Evaluate Security Results
        run: |
          GATE_STATUS="PASSED"
          HIGH_SEVERITY_FOUND="false"
            
          echo "## Security Gate Evaluation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check SAST job status (informational)
          if [ "${{ needs.sast-scan.result }}" == "failure" ]; then
            echo "SAST (SonarCloud): FAILED - Review static analysis results in SonarCloud" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.sast-scan.result }}" == "skipped" ]; then
            echo "SAST (SonarCloud): SKIPPED" >> $GITHUB_STEP_SUMMARY
          else
            echo "SAST (SonarCloud): PASSED" >> $GITHUB_STEP_SUMMARY
          fi

          # Check SCA for high severity vulnerabilities (CVSS ≥ 7.0)
          if [ "${{ needs.sca-scan.result }}" == "failure" ]; then
            echo "SCA (Snyk): FAILED - High severity vulnerabilities detected (CVSS ≥ 7.0)" >> $GITHUB_STEP_SUMMARY
            GATE_STATUS="FAILED"
            HIGH_SEVERITY_FOUND="true"
          elif [ "${{ needs.sca-scan.result }}" == "skipped" ]; then
            echo "SCA (Snyk): SKIPPED" >> $GITHUB_STEP_SUMMARY
          else
            echo "SCA (Snyk): PASSED" >> $GITHUB_STEP_SUMMARY
          fi

          # Check DAST job status (informational)
          if [ "${{ needs.dast-scan.result }}" == "failure" ]; then
            echo "DAST (OWASP ZAP): WARNINGS - Review ZAP report for findings" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.dast-scan.result }}" == "skipped" ]; then
            echo "DAST (OWASP ZAP): SKIPPED" >> $GITHUB_STEP_SUMMARY
          else
            echo "DAST (OWASP ZAP): PASSED" >> $GITHUB_STEP_SUMMARY
          fi
            
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Security Gate Status: $GATE_STATUS" >> $GITHUB_STEP_SUMMARY

          if [ "$HIGH_SEVERITY_FOUND" == "true" ]; then
            echo " MERGE BLOCKED: High severity vulnerabilities detected in dependencies (CVSS ≥ 7.0)" >> $GITHUB_STEP_SUMMARY
            echo "Action Required: Fix all high severity findings before merging" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Block Merge on High Severity
        if: needs.sca-scan.result == 'failure'
        run: |
          echo "::error::MERGE BLOCKED: High severity vulnerabilities detected in dependencies (CVSS ≥ 7.0)"
          echo "::error::Please fix all high severity (CVSS ≥ 7.0) vulnerabilities before merging"
          exit 1

      # Final security gate status determination
      # Blocks merge if high-severity vulnerabilities found
      - name: Final Security Gate Status
        run: |
          if [ "${{ needs.sca-scan.result }}" == "failure" ]; then
            echo "SECURITY GATE: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "Merge is blocked due to high severity dependency vulnerabilities." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "SECURITY GATE: PASSED" >> $GITHUB_STEP_SUMMARY
            echo "All mandatory security checks passed." >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # JOB 6: DEPLOYMENT (DEMO ONLY)
  # ============================================
  # Purpose: Demonstrate Docker Compose deployment
  # Note: This is a demo deployment for testing purposes
  # Compliance: Production deployment would require additional security
  deploy-compose:
    name: Deploy (Docker Compose)
    runs-on: ubuntu-latest
    needs: security-gate
    timeout-minutes: 5

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Build and run application with Docker Compose
      # Demonstrates production-ready deployment configuration
      - name: Build and Run with Docker Compose
        run: |
          docker compose up -d --build

          echo "Waiting for application to become healthy via Docker Compose..."
          for i in {1..10}; do
            if curl -s http://localhost:3000/health > /dev/null 2>&1; then
              echo "Application is healthy via Docker Compose"
              break
            fi
            echo "Waiting... ($i/10)"
            sleep 5
            if [ $i -eq 10 ]; then
              echo "Application failed to become healthy via Docker Compose"
              docker compose logs
              exit 1
            fi
          done

      # Clean up Docker Compose deployment
      # Ensures proper cleanup after demo deployment
      - name: Stop Docker Compose
        if: always()
        run: |
          docker compose down || true

    # ============================================
  # JOB 7: COMPLIANCE REPORT GENERATION
  # ============================================
  # Purpose: Generate executive summary report
  # Compliance: PDPL and CBB Framework documentation
  # Output: GitHub Actions summary with security metrics
  generate-report:
    name: Generate Report
    runs-on: ubuntu-latest
    needs: [build-and-test, sast-scan, sca-scan, dast-scan, security-gate, deploy-compose]
    if: always()

    steps:
      # Generate comprehensive compliance report
      # Includes pipeline info, security results, and compliance status
      - name: Generate Compliance Report
        run: |
          cat > compliance-report-${{ github.run_number }}.md << 'EOF'
          # FinSecure DevSecOps Compliance Report
          
          ## Executive Summary
          - **Report ID**: #${{ github.run_number }}
          - **Date**: $(date '+%Y-%m-%d %H:%M:%S UTC')
          - **Scope**: Proof-of-concept compliance validation
          - **Pipeline Runtime**: ~15 minutes
          
          ## Compliance Assessment
          
          ### PDPL (Bahrain Personal Data Protection Law)
          | Requirement | Status | Evidence |
          |-------------|--------|----------|
          | Data Protection | ✅ COMPLIANT | Synthetic data only, no PII |
          | Secure Storage | ✅ COMPLIANT | GitHub Secrets encryption |
          | Audit Trail | ✅ COMPLIANT | Pipeline execution logs |
          | Data Minimization | ✅ COMPLIANT | Essential demo data only |
          
          ### CBB Cybersecurity Framework
          | Requirement | Status | Evidence |
          |-------------|--------|----------|
          | Security Testing | ✅ COMPLIANT | SAST/SCA/DAST automated |
          | Access Control | ✅ COMPLIANT | Branch protection enabled |
          | Vulnerability Mgmt | ${{ needs.sca-scan.result == 'success' && '✅ COMPLIANT' || '⚠️ REVIEW' }} | Snyk scanning results |
          | Continuous Monitoring | ✅ COMPLIANT | Automated pipeline triggers |
          
          ## Security Scan Results
          | Scan Type | Tool | Result | Findings |
          |-----------|------|--------|----------|
          | SAST | SonarCloud | ${{ needs.sast-scan.result == 'success' && 'PASS' || 'REVIEW' }} | View SonarCloud dashboard |
          | SCA | Snyk | ${{ needs.sca-scan.result == 'success' && 'PASS' || 'FAIL' }} | High/Critical CVE blocking |
          | DAST | OWASP ZAP | ${{ needs.dast-scan.result == 'success' && 'PASS' || 'WARNINGS' }} | HTML report artifact |
          
          ## Compliance Status
          - **Overall Compliance**: ${{ needs.security-gate.result == 'success' && '✅ COMPLIANT' || '⚠️ ACTION REQUIRED' }}
          - **Security Gate**: ${{ needs.security-gate.result == 'success' && 'PASSED' || 'FAILED' }}
          - **Merge Status**: ${{ needs.security-gate.result == 'success' && 'ALLOWED' || 'BLOCKED' }}
          
          ---
          *Generated automatically by FinSecure DevSecOps Pipeline*
          *Framework Compliance: PDPL & CBB Cybersecurity Framework*
          EOF
          
          # Upload compliance report as artifact
          echo "Compliance report generated: compliance-report-${{ github.run_number }}.md"

      - name: Upload Compliance Report
        uses: actions/upload-artifact@v4
        with:
          name: compliance-report-${{ github.run_number }}
          path: compliance-report-${{ github.run_number }}.md
          retention-days: 30

      # Generate GitHub Actions summary
      - name: Generate Executive Report
        run: |
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY

          # FinSecure DevSecOps Pipeline Report

          ## Pipeline Information
          | Property | Value |
          |----------|-------|
          | **Run** | #${{ github.run_number }} |
          | **Commit** | `${{ github.sha }}` |
          | **Branch** | `${{ github.ref_name }}` |
          | **Actor** | @${{ github.actor }} |
          | **Event** | `${{ github.event_name }}` |

          ## Security Scan Summary
          | Scan | Tool | Status |
          |------|------|--------|
          | SAST | SonarCloud | ${{ needs.sast-scan.result == 'success' && 'Passed' || needs.sast-scan.result == 'skipped' && 'Skipped' || 'Review' }} |
          | SCA | Snyk | ${{ needs.sca-scan.result == 'success' && 'Passed' || needs.sca-scan.result == 'skipped' && 'Skipped' || 'Review' }} |
          | DAST | OWASP ZAP | ${{ needs.dast-scan.result == 'success' && 'Passed' || needs.dast-scan.result == 'skipped' && 'Skipped' || 'Review' }} |

          ## Compliance Status

          ### PDPL (Bahrain Personal Data Protection Law)
          - ✅ Secrets encrypted via GitHub Secrets
          - ✅ No personal data in logs
          - ✅ Mock data used for testing
          - ✅ Data protection measures implemented

          ### CBB Cybersecurity Framework
          - ✅ Automated security testing
          - ✅ Vulnerability scanning
          - ✅ Access controls enabled
          - ✅ Audit trail maintained
          - ✅ Security gates enforced

          ## Security Metrics
          - Total Pipeline Runtime: ~15 minutes
          - Security Tools Integrated: 3 (SAST, SCA, DAST)
          - Artifact Retention: 30 days
          - Coverage: OWASP Top 10

          ---
          *Generated by FinSecure Application's Automated DevSecOps Pipeline*
          *Compliance: PDPL & CBB Cybersecurity Framework*
          EOF
